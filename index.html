<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-O WORLD | ONLINE</title>
    <style>
        :root { --bg: #1a1a2e; --card: #16213e; --accent: #0f3460; --x-color: #e94560; --o-color: #4ecca3; --text: #ffffff; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 10px; }
        .container { width: 100%; max-width: 400px; text-align: center; }
        #status { background: var(--accent); padding: 12px; border-radius: 12px; margin: 10px 0; font-weight: bold; border: 2px solid transparent; }
        
        /* Ù„ÙˆØ­Ø© Ø§Ù„Ù„Ø¹Ø¨ */
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; background: var(--accent); padding: 10px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .cell { aspect-ratio: 1/1; background: var(--card); border-radius: 10px; display: flex; justify-content: center; align-items: center; font-size: 3rem; cursor: pointer; transition: 0.2s; font-weight: bold; }
        .cell.X { color: var(--x-color); }
        .cell.O { color: var(--o-color); }

        /* Ø§Ù„Ø´Ø§Øª */
        .chat-area { margin-top: 15px; background: var(--card); border-radius: 15px; height: 250px; display: flex; flex-direction: column; border: 1px solid var(--accent); }
        #msgs { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        .msg-line { display: flex; align-items: center; gap: 8px; }
        .my-row { flex-direction: row; }
        .other-row { flex-direction: row-reverse; }
        .msg-bubble { padding: 8px 12px; border-radius: 12px; font-size: 0.9rem; max-width: 75%; }
        .my-msg { background: var(--o-color); color: #1a1a2e; font-weight: bold; }
        .other-msg { background: var(--accent); color: white; }
        .del-btn { background: none; border: none; color: #ff4757; cursor: pointer; font-size: 1rem; padding: 0; }

        .input-box { display: flex; padding: 8px; background: var(--accent); border-radius: 0 0 15px 15px; }
        input { flex: 1; background: none; border: none; color: white; outline: none; padding: 5px; }
        .send-btn { background: var(--o-color); border: none; border-radius: 8px; padding: 5px 15px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <h2 style="color: var(--o-color);">X-O Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ğŸ®</h2>
        <div id="playerInfo" style="font-size: 0.8rem; color: #aaa;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>
        <div id="status">Ø§Ù†ØªØ¸Ø± Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø®ØµÙ…...</div>

        <div class="grid" id="board">
            <div class="cell" onclick="handlePlay(0)"></div>
            <div class="cell" onclick="handlePlay(1)"></div>
            <div class="cell" onclick="handlePlay(2)"></div>
            <div class="cell" onclick="handlePlay(3)"></div>
            <div class="cell" onclick="handlePlay(4)"></div>
            <div class="cell" onclick="handlePlay(5)"></div>
            <div class="cell" onclick="handlePlay(6)"></div>
            <div class="cell" onclick="handlePlay(7)"></div>
            <div class="cell" onclick="handlePlay(8)"></div>
        </div>

        <div class="chat-area">
            <div id="msgs"></div>
            <div class="input-box">
                <input type="text" id="chatInp" placeholder="Ø§Ø±Ø³Ù„ Ø±Ø³Ø§Ù„Ø©...">
                <button class="send-btn" onclick="sendMsg()">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ Ø§Ù„ØªÙŠ Ø£Ø±Ø³Ù„ØªÙ‡Ø§
        const firebaseConfig = {
            apiKey: "AIzaSyBopnQ0bLP60tuYXxlFUeKRfeesXDfz3MI",
            authDomain: "x-o2-fa961.firebaseapp.com",
            databaseURL: "https://x-o2-fa961-default-rtdb.firebaseio.com",
            projectId: "x-o2-fa961",
            storageBucket: "x-o2-fa961.firebasestorage.app",
            messagingSenderId: "19053737189",
            appId: "1:19053737189:web:1ccd0671544318c4da900c",
            measurementId: "G-3CC19WN7JN"
        };

        firebase.initializeApp(firebaseConfig);
        const roomID = prompt("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ© (Ù…Ø«Ù„Ø§Ù‹ 55):", "1");
        const db = firebase.database().ref('rooms/' + roomID);
        
        let mySym = "";
        const clickSnd = new Audio('https://www.soundjay.com/buttons/sounds/button-16.mp3');

        // Ù†Ø¸Ø§Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
        db.child('players').transaction(p => p === null ? {p1:true} : (p.p2 === undefined ? {p1:true, p2:true} : undefined), 
        (err, committed, snap) => {
            const d = snap.val();
            mySym = (d.p2 && !mySym) ? 'O' : 'X';
            document.getElementById('playerInfo').innerText = "ØºØ±ÙØ©: " + roomID + " | Ø£Ù†Øª Ø§Ù„Ù„Ø§Ø¹Ø¨: " + mySym;
        });

        // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
        db.child('game').on('value', snap => {
            const data = snap.val() || {board: Array(9).fill(""), turn: 'X', status: 'playing'};
            const cells = document.querySelectorAll('.cell');
            data.board.forEach((v, i) => {
                cells[i].innerText = v;
                cells[i].className = `cell ${v}`;
            });
            
            const st = document.getElementById('status');
            if(data.status === 'win') {
                st.innerText = "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠ! ğŸ‰";
                st.style.borderColor = "gold";
            } else {
                st.innerText = (data.turn === mySym) ? "Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù†!" : `Ø§Ù†ØªØ¸Ø± ${data.turn}...`;
                st.style.borderColor = (data.turn === mySym) ? "var(--o-color)" : "var(--x-color)";
            }
        });

        function handlePlay(i) {
            db.child('game').once('value', snap => {
                const data = snap.val() || {board: Array(9).fill(""), turn: 'X', status: 'playing'};
                if(data.board[i] === "" && data.turn === mySym && data.status === 'playing') {
                    clickSnd.play();
                    data.board[i] = mySym;
                    data.turn = (mySym === 'X') ? 'O' : 'X';
                    db.child('game').update(data);
                    checkWinner(data.board);
                }
            });
        }

        function checkWinner(b) {
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            wins.forEach(c => { if(b[c[0]] && b[c[0]]===b[c[1]] && b[c[0]]===b[c[2]]) db.child('game/status').set('win'); });
        }

        // Ø§Ù„Ø´Ø§Øª Ù…Ø¹ Ù…ÙŠØ²Ø© Ø§Ù„Ø­Ø°Ù
        function sendMsg() {
            const inp = document.getElementById('chatInp');
            if(inp.value.trim()) {
                db.child('chat').push({u: mySym, m: inp.value});
                inp.value = "";
            }
        }

        db.child('chat').on('value', snap => {
            const box = document.getElementById('msgs');
            box.innerHTML = "";
            snap.forEach(s => {
                const d = s.val();
                const isMe = d.u === mySym;
                const row = document.createElement('div');
                row.className = `msg-line ${isMe ? 'my-row' : 'other-row'}`;
                row.innerHTML = `
                    <div class="msg-bubble ${isMe ? 'my-msg' : 'other-msg'}">${d.m}</div>
                    ${isMe ? `<button class="del-btn" onclick="del('${s.key}')">ğŸ—‘ï¸</button>` : ""}
                `;
                box.appendChild(row);
            });
            box.scrollTop = box.scrollHeight;
        });

        function del(key) { db.child('chat').child(key).remove(); }
    </script>
</body>
</html>
