<!DOCTYPE html><html><head><style></style></head><body><!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-O PRO | Online</title>
    <style>
        :root { --bg: #1a1a2e; --card: #16213e; --accent: #0f3460; --x-color: #e94560; --o-color: #4ecca3; --text: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { width: 95%; max-width: 400px; text-align: center; padding: 10px; }
        
        /* لوحة اللعب */
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; background: var(--accent); padding: 10px; border-radius: 15px; margin-bottom: 20px; }
        .cell { aspect-ratio: 1/1; background: var(--card); border-radius: 10px; display: flex; justify-content: center; align-items: center; font-size: 3rem; cursor: pointer; transition: 0.2s; }
        
        /* الشات الاحترافي */
        .chat-box { background: var(--card); border-radius: 15px; display: flex; flex-direction: column; height: 300px; border: 1px solid var(--accent); width: 100%; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; background: rgba(0,0,0,0.1); }
        
        .msg-row { display: flex; width: 100%; align-items: center; gap: 8px; }
        .my-row { justify-content: flex-start; flex-direction: row; } /* أنا يمين */
        .other-row { justify-content: flex-end; flex-direction: row-reverse; } /* الخصم يسار */

        .msg-bubble { padding: 10px 15px; border-radius: 15px; font-size: 0.95rem; max-width: 75%; position: relative; word-wrap: break-word; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .my-bubble { background: var(--o-color); color: #1a1a2e; font-weight: bold; border-bottom-right-radius: 2px; }
        .other-bubble { background: var(--accent); color: white; border-bottom-left-radius: 2px; }

        .delete-btn { background: #ff4757; color: white; border: none; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; }
        
        .chat-controls { display: flex; padding: 10px; background: var(--accent); border-bottom-left-radius: 15px; border-bottom-right-radius: 15px; }
        #chatInput { flex: 1; background: none; border: none; color: white; outline: none; padding: 5px; }
        .send-btn { background: var(--o-color); border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <h2>X-O أونلاين</h2>
        <div id="playerInfo" style="margin-bottom: 10px; color: var(--o-color);">جاري الاتصال...</div>
        
        <div class="grid" id="board">
            <div class="cell" onclick="makeMove(0)"></div>
            <div class="cell" onclick="makeMove(1)"></div>
            <div class="cell" onclick="makeMove(2)"></div>
            <div class="cell" onclick="makeMove(3)"></div>
            <div class="cell" onclick="makeMove(4)"></div>
            <div class="cell" onclick="makeMove(5)"></div>
            <div class="cell" onclick="makeMove(6)"></div>
            <div class="cell" onclick="makeMove(7)"></div>
            <div class="cell" onclick="makeMove(8)"></div>
        </div>

        <div class="chat-box">
            <div id="messages"></div>
            <div class="chat-controls">
                <input type="text" id="chatInput" placeholder="اكتب رسالة...">
                <button class="send-btn" onclick="sendMessage()">إرسال</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // --- إعدادات Firebase ---
        const firebaseConfig = {
            apiKey: "AIza...",
            databaseURL: "https://your-project.firebaseio.com",
            projectId: "your-project",
            appId: "1:..."
        };
        firebase.initializeApp(firebaseConfig);

        const roomID = prompt("رقم الغرفة:", "100");
        const db = firebase.database().ref('rooms/' + roomID);
        let mySymbol = "";

        // تحديد الهوية
        db.child('players').transaction(d => d === null ? {p1:true} : (d.p2 === undefined ? {p1:true, p2:true} : undefined), 
        (err, c, snap) => {
            const players = snap.val();
            mySymbol = (players.p2 && !mySymbol) ? 'O' : 'X';
            document.getElementById('playerInfo').innerText = "أنت اللاعب: " + mySymbol;
        });

        // مزامنة اللعبة
        db.child('game').on('value', s => {
            const data = s.val() || {board: Array(9).fill(""), turn: 'X'};
            data.board.forEach((v, i) => {
                const c = document.querySelectorAll('.cell')[i];
                c.innerText = v;
                c.style.color = v === 'X' ? 'var(--x-color)' : 'var(--o-color)';
            });
        });

        function makeMove(i) {
            db.child('game').once('value', s => {
                const data = s.val() || {board: Array(9).fill(""), turn: 'X'};
                if(data.board[i] === "" && data.turn === mySymbol) {
                    data.board[i] = mySymbol;
                    data.turn = mySymbol === 'X' ? 'O' : 'X';
                    db.child('game').update(data);
                }
            });
        }

        // --- نظام الشات (الحل النهائي) ---
        function sendMessage() {
            const inp = document.getElementById('chatInput');
            if(inp.value.trim() !== "") {
                db.child('chat').push({
                    user: mySymbol,
                    text: inp.value,
                    time: Date.now()
                });
                inp.value = "";
            }
        }

        db.child('chat').on('value', (snap) => {
            const msgBox = document.getElementById('messages');
            msgBox.innerHTML = ""; // نمسح القديم ونعيد الرسم لضمان الترتيب
            
            snap.forEach((child) => {
                const data = child.val();
                const isMe = data.user === mySymbol;

                const row = document.createElement('div');
                row.className = `msg-row ${isMe ? 'my-row' : 'other-row'}`;

                const bubble = document.createElement('div');
                bubble.className = `msg-bubble ${isMe ? 'my-bubble' : 'other-bubble'}`;
                bubble.innerText = data.text;

                row.appendChild(bubble);

                // إضافة زر الحذف لرسائلي فقط
                if(isMe) {
                    const del = document.createElement('button');
                    del.className = 'delete-btn';
                    del.innerHTML = '✕';
                    del.onclick = () => db.child('chat').child(child.key).remove();
                    row.appendChild(del);
                }

                msgBox.appendChild(row);
            });
            msgBox.scrollTop = msgBox.scrollHeight;
        });
    </script>
</body>
</html><script></script></body></html>